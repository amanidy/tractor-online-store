generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String          @id @default(uuid())
  name           String
  email          String          @unique
  phone          String?         @unique
  password       String
  isVerified     Boolean         @default(false)
  role           String
  createdAt      DateTime        @default(now())
  userrole       UserRole
  dealer         Dealer?
  listings       Listing[]
  qualityReports QualityReport[] @relation("ReportedByReports")
  tractors       Tractor[]
  purchases      Transaction[]   @relation("BuyerTransactions")
  sales          Transaction[]   @relation("SellerTransactions")
}

model Tractor {
  id             String       @id @default(uuid())
  title          String
  description    String?
  price          Float?
  location       String?
  specifications String?
  history        String?
  images         String[]
  sellerId       String
  createdAt      DateTime     @default(now())
  isApproved     Boolean      @default(false)
  categoryId     String?
  imageUrl       String?
  updatedAt      DateTime     @updatedAt
  attachments    Attachment[]
  details        Detail[]
  inquiries      Inquiry[]
  purchases      Purchase[]
  sales          Sale[]
  category       Category?    @relation(fields: [categoryId], references: [id])
  seller         User         @relation(fields: [sellerId], references: [id])

  @@index([categoryId])
}

model Category {
  id       String    @id @default(uuid())
  name     String    @unique
  tractors Tractor[]
}

model Attachment {
  id        String   @id @default(uuid())
  name      String
  url       String
  tractorId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tractor   Tractor  @relation(fields: [tractorId], references: [id], onDelete: Cascade)

  @@index([tractorId])
}

model Inquiry {
  id        String   @id @default(uuid())
  tractorId String
  name      String
  email     String
  message   String
  createdAt DateTime @default(now())
  tractor   Tractor  @relation(fields: [tractorId], references: [id])
}

model Sale {
  id        String   @id @default(uuid())
  tractorId String
  buyerName String
  price     Float
  createdAt DateTime @default(now())
  tractor   Tractor  @relation(fields: [tractorId], references: [id])
}

model Listing {
  id             String           @id @default(cuid())
  title          String
  description    String
  category       String
  make           String
  model          String
  year           Int
  condition      ListingCondition
  price          Float
  location       String
  images         String[]
  status         ListingStatus    @default(PENDING)
  sellerId       String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  seller         User             @relation(fields: [sellerId], references: [id])
  qualityReports QualityReport[]
  transactions   Transaction[]
}

model Transaction {
  id        String            @id @default(cuid())
  listingId String
  buyerId   String
  sellerId  String
  price     Float
  status    TransactionStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  buyer     User              @relation("BuyerTransactions", fields: [buyerId], references: [id])
  listing   Listing           @relation(fields: [listingId], references: [id])
  seller    User              @relation("SellerTransactions", fields: [sellerId], references: [id])
}

model QualityReport {
  id           String              @id @default(cuid())
  listingId    String
  reportedById String
  description  String
  severity     QualitySeverity
  status       QualityReportStatus @default(OPEN)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  listing      Listing             @relation(fields: [listingId], references: [id])
  reportedBy   User                @relation("ReportedByReports", fields: [reportedById], references: [id])
}

model AdminActivityLog {
  id          String   @id @default(uuid())
  type        String
  description String
  details     String?
  timestamp   DateTime @default(now())

  @@index([type])
  @@index([timestamp])
}

model Dealer {
  id           String     @id @default(uuid())
  name         String
  location     String
  contactEmail String
  contactPhone String
  dealerType   DealerType
  specialties  String[]
  rating       Float      @default(0.0)
  verified     Boolean    @default(false)
  userId       String     @unique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  user         User       @relation(fields: [userId], references: [id])
  products     Product[]
}

model Product {
  id        String   @id @default(uuid())
  name      String
  category  String
  price     Decimal
  inStock   Boolean  @default(true)
  dealerId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  dealer    Dealer   @relation(fields: [dealerId], references: [id], onDelete: Cascade)
}

model Detail {
  id              String            @id @default(uuid())
  title           String
  description     String?
  videoUrl        String?
  position        Int
  isVerified      Boolean           @default(false)
  isNegotiable    Boolean           @default(false)
  tractorId       String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  isPublished     Boolean           @default(false)
  isStandard      Boolean           @default(false)
  tractor         Tractor           @relation(fields: [tractorId], references: [id], onDelete: Cascade)
  muxData         MuxData?
  viewingProgress ViewingProgress[]

  @@index([tractorId])
}

model MuxData {
  id         String  @id @default(uuid())
  detailId   String  @unique
  assetId    String
  playbackId String?
  detail     Detail  @relation(fields: [detailId], references: [id], onDelete: Cascade)
}

model ViewingProgress {
  id          String   @id @default(uuid())
  userId      String
  detailId    String
  isCompleted Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  detail      Detail   @relation(fields: [detailId], references: [id], onDelete: Cascade)

  @@unique([userId, detailId])
  @@index([detailId])
}

model Purchase {
  id        String   @id @default(uuid())
  userId    String
  tractorId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tractor   Tractor  @relation(fields: [tractorId], references: [id], onDelete: Cascade)

  @@index([tractorId])
}

model StripeCustomer {
  id               String   @id @default(uuid())
  userId           String   @unique
  stripeCustomerId String   @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

enum UserRole {
  ADMIN
  SELLER
  BUYER
  DEALER
}

enum ListingStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ListingCondition {
  NEW
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum QualitySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum QualityReportStatus {
  OPEN
  INVESTIGATED
  RESOLVED
  CLOSED
}

enum DealerType {
  TractorParts
  EquipmentSupplier
  Comprehensive
}
